plugins {
    id 'com.github.johnrengelman.shadow'
}

ext {
    javaFxVersion = '17-ea+11'
    monocleVersion = '12.0.1+2'
}

dependencies {
    implementation project(':logic')
    ['win', 'mac', 'linux'].forEach {platform ->
        implementation "org.openjfx:javafx-base:$javaFxVersion:$platform"
        implementation "org.openjfx:javafx-graphics:$javaFxVersion:$platform"
        implementation "org.openjfx:javafx-controls:$javaFxVersion:$platform"
    }

    implementation "org.apache.logging.log4j:log4j-api:$log4jVersion"
    implementation "org.eclipse.jdt:org.eclipse.jdt.annotation:2.2.600"
    implementation "jakarta.json.bind:jakarta.json.bind-api:${jsonBindApiVersion}"

    runtimeOnly "org.apache.logging.log4j:log4j-core:${log4jVersion}"
    runtimeOnly "org.apache.logging.log4j:log4j-jul:${log4jVersion}"
    runtimeOnly "org.fusesource.jansi:jansi:2.3.4"

    testImplementation "jakarta.json.bind:jakarta.json.bind-api:${jsonBindApiVersion}"
    testRuntimeOnly "org.eclipse:yasson:${yassonVersion}"

    testImplementation "org.testfx:testfx-junit5:4.0.16-alpha"
    testRuntimeOnly "org.testfx:openjfx-monocle:jdk-$monocleVersion"
}

shadowJar {
    archiveBaseName.set('white-rabbit-fx')
    archiveClassifier.set(null)
    archiveVersion.set(project.version.toString())
}

ext {
    mainClass = 'org.itsallcode.whiterabbit.jfxui.App'
}

jar {
    manifest {
        attributes 'Main-Class': project.mainClass
    }
}

build.dependsOn shadowJar

project(':plugins').afterEvaluate {
    List<Task> pluginJarTasks = project(':plugins').ext.pluginBuildTasks
    
    def userHome = System.properties['user.home']
    if(project.hasProperty('user.home')) {
    	userHome = project.property('user.home')
    }
    
    task runJfxuiWithPlugins(type: JavaExec, dependsOn: [shadowJar] + pluginJarTasks, group: 'run') {
        group = "run"
        def pluginJars = files(pluginJarTasks.collect {it.outputs.files })
        classpath = shadowJar.outputs.files + pluginJars
        mainClass = project.mainClass
        workingDir = rootProject.projectDir
        systemProperties = ['user.home': userHome]
    }
}

task runJfxui(type: JavaExec, dependsOn: shadowJar, group: 'run') {
    classpath = shadowJar.outputs.files
    mainClass = project.mainClass
    workingDir = rootProject.projectDir
}

sourceSets {
    uiTest {
        compileClasspath += sourceSets.main.output
        runtimeClasspath += sourceSets.main.output
    }
}

configurations {
    uiTestImplementation.extendsFrom testImplementation
    uiTestRuntimeOnly.extendsFrom testRuntimeOnly
}

task uiTest(type: Test, group: 'verification') {
    description = 'Runs integration tests.'

    useJUnitPlatform()

    forkEvery 5
    jvmArgs '-XX:+HeapDumpOnOutOfMemoryError'

    if(!project.hasProperty("uiTestsHeadless") || project.property("uiTestsHeadless") != "false") {
        systemProperty 'java.awt.headless', 'true'
        systemProperty 'testfx.headless', 'true'
        systemProperty 'testfx.robot', 'glass'
        systemProperty 'glass.platform', 'Monocle'
        systemProperty 'monocle.platform', 'Headless'
    }

    systemProperty 'testfx.launch.timeout', '60000'
    systemProperty 'testfx.setup.timeout', '30000'

    testClassesDirs = sourceSets.uiTest.output.classesDirs
    classpath = sourceSets.uiTest.runtimeClasspath
    shouldRunAfter test
}

check.dependsOn uiTest

tasks["jacocoTestReport"].executionData fileTree(project.buildDir).include("jacoco/*.exec")
